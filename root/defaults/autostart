# Set layout to avoid keybinding warnings
setxkbmap -layout us &

export DISABLE_QT5_COMPAT=1
export LC_ALL=en_US.UTF-8

# Run automated setup before Anki starts (if credentials provided)
SETUP_MARKER="/config/.local/share/Anki2/.setup_complete"
AUTO_SYNC="${AUTO_SYNC_ON_START:-true}"

if [ -n "$ANKIWEB_USER" ] && { [ -n "$ANKIWEB_PASSWORD" ] || [ -n "$ANKIWEB_SYNC_KEY" ]; }; then
    if [ ! -f "/config/.local/share/Anki2/prefs21.db" ]; then
        echo "[*] Running automated Anki setup..."
        if python3 /app/scripts/setup_anki.py setup-all --config-dir /config; then
            echo "[OK] Setup completed successfully"
            # Mark first-time setup complete for sync trigger
            mkdir -p /config/.local/share/Anki2
            touch "$SETUP_MARKER"
        else
            echo "[ERROR] Setup failed"
        fi
    fi
fi

# Start Anki GUI
anki &
ANKI_PID=$!

# Start the dialog helper on each launch. It exits quietly when no initial
# "Download from AnkiWeb?" prompt is present.
if [ "$AUTO_SYNC" = "true" ]; then
    echo "[*] Starting GUI automation for sync popup..."
    /app/scripts/auto_sync_gui.sh &
fi

# First-run marker no longer needed after startup checks.
rm -f "$SETUP_MARKER"

# Wait for Anki process
wait $ANKI_PID
