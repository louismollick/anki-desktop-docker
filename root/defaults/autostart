# Set layout to avoid keybinding warnings
setxkbmap -layout us &

export DISABLE_QT5_COMPAT=1
export LC_ALL=en_US.UTF-8

# Run automated setup before Anki starts (if credentials provided)
SETUP_MARKER="/config/.local/share/Anki2/.setup_complete"
AUTO_SYNC="${AUTO_SYNC_ON_START:-true}"

if [ -n "$ANKIWEB_USER" ] && { [ -n "$ANKIWEB_PASSWORD" ] || [ -n "$ANKIWEB_SYNC_KEY" ]; }; then
    if [ ! -f "/config/.local/share/Anki2/prefs21.db" ]; then
        echo "[*] Running automated Anki setup..."
        if python3 /app/scripts/setup_anki.py setup-all --config-dir /config; then
            echo "[OK] Setup completed successfully"
            # Mark first-time setup complete for sync trigger
            mkdir -p /config/.local/share/Anki2
            touch "$SETUP_MARKER"
        else
            echo "[ERROR] Setup failed"
        fi
    fi
fi

# Start Anki GUI
anki &
ANKI_PID=$!

# Auto-sync on every startup via AnkiConnect.
if [ "$AUTO_SYNC" = "true" ]; then
    (
        API_KEY="${ANKICONNECT_API_KEY:-}"
        SYNC_RESPONSE=""
        for _ in $(seq 1 45); do
            if [ -n "$API_KEY" ]; then
                SYNC_RESPONSE=$(curl -fsS -m 10 localhost:8765 -X POST -d "{\"action\":\"sync\",\"version\":6,\"key\":\"$API_KEY\"}" || true)
            else
                SYNC_RESPONSE=$(curl -fsS -m 10 localhost:8765 -X POST -d '{"action":"sync","version":6}' || true)
            fi

            if [ -n "$SYNC_RESPONSE" ]; then
                echo "[OK] Startup sync response: $SYNC_RESPONSE"
                exit 0
            fi
            sleep 2
        done

        echo "[WARN] Startup sync did not complete before timeout"
    ) &
fi

# First-run marker no longer needed after startup checks.
rm -f "$SETUP_MARKER"

# Wait for Anki process
wait $ANKI_PID
